name: Build Nginx Windows with RTMP/HLS/HTTP-FLV

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout nginx source
        uses: actions/checkout@v4
        with:
          repository: nginx/nginx
          path: nginx

      - name: Checkout nginx-http-flv-module
        uses: actions/checkout@v4
        with:
          repository: winshining/nginx-http-flv-module
          path: nginx-http-flv-module

      - name: Checkout nginx-rtmp-module
        uses: actions/checkout@v4
        with:
          repository: arut/nginx-rtmp-module
          path: nginx-rtmp-module

      - name: Setup Visual Studio
        uses: microsoft/setup-msbuild@v2
        with:
          vs-version: '[17.0,18.0)'

      - name: Setup Perl
        uses: shogo82148/actions-setup-perl@v1
        with:
          perl-version: '5.34'

      - name: Download dependencies
        shell: bash
        run: |
          mkdir -p nginx/objs/lib
          cd nginx/objs/lib
          curl -L https://github.com/PCRE2Project/pcre2/releases/download/pcre2-10.42/pcre2-10.42.zip -o pcre2.zip
          curl -L https://zlib.net/zlib1213.zip -o zlib.zip
          curl -L https://www.openssl.org/source/openssl-1.1.1w.tar.gz -o openssl.tar.gz
          unzip -q pcre2.zip && mv pcre2-* pcre2
          unzip -q zlib.zip && mv zlib-* zlib
          tar -xf openssl.tar.gz && mv openssl-* openssl

      - name: Configure nginx
        shell: cmd
        run: |
          cd nginx
          auto/configure \
            --with-cc=cl \
            --prefix= \
            --conf-path=conf/nginx.conf \
            --pid-path=logs/nginx.pid \
            --http-log-path=logs/access.log \
            --error-log-path=logs/error.log \
            --sbin-path=nginx.exe \
            --with-pcre=objs/lib/pcre2 \
            --with-zlib=objs/lib/zlib \
            --with-openssl=objs/lib/openssl \
            --with-http_ssl_module \
            --add-module=../../nginx-http-flv-module \
            --add-module=../../nginx-rtmp-module

      - name: Build nginx
        shell: cmd
        run: |
          cd nginx
          nmake -f objs/Makefile

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: nginx-windows-with-rtmp-hls-httpflv
          path: |
            nginx/objs/nginx.exe
            nginx/conf
            nginx/docs
            nginx/html
            nginx/contrib